package modem

import chisel3._
import chisel3.util._
import chisel3.experimental.FixedPoint

object FIRCodes {
  val NONE            = 0.U
  val TX_GAUSSIAN     = 1.U
  val RX_HILBERT_I    = 2.U
  val RX_HILBERT_Q    = 3.U
  val RX_MATCH_SIN_F0 = 4.U
  val RX_MATCH_COS_F0 = 5.U
  val RX_MATCH_SIN_F1 = 6.U
  val RX_MATCH_COS_F1 = 7.U
  val RX_LPF          = 8.U
}

case class FIRConfig(
  name: UInt,
  dataType: FixedPoint,
  coefficients: Seq[Double]
)

case class FIRMode(
  RX_match_sin_f0: FIRConfig,
  RX_match_cos_f0: FIRConfig,
  RX_match_sin_f1: FIRConfig,
  RX_match_cos_f1: FIRConfig,
  RX_lpf: FIRConfig
)

object FIRConfigs {
  /*  Generated by software/models/gaussfir.m

      Padded to length 24 for flexibility
   */
  val TX_Gaussian = FIRConfig(
    FIRCodes.TX_GAUSSIAN,
    FixedPoint(8.W, 6.BP),
    Seq[Double](
      0.000076, 0.000180, 0.000404, 0.000856, 0.001715, 0.003252, 0.005832, 0.009892,
      0.015870, 0.024085, 0.034575, 0.046949, 0.060301, 0.073260, 0.084189, 0.091515,
      0.094096, 0.091515, 0.084189, 0.073260, 0.060301, 0.046949, 0.034575, 0.024085,
      0.015870, 0.009892, 0.005832, 0.003252, 0.001715, 0.000856, 0.000404, 0.000180,
      0.000076
    ).map(i => i * 2) // artifact of implementation
  )

  /*  Generated by software/models/notebooks/ble.ipynb

      Padded to length 32 for flexibility
   */
  val RX_Hilbert_I = FIRConfig(
    FIRCodes.RX_HILBERT_I,
    FixedPoint(16.W, 12.BP),
    Seq[Double](
      0.0, -0.049072265625, 0.0, -0.057861328125, 0.0, -0.07080078125,  0.0, -0.091064453125,
      0.0, -0.12744140625,  0.0, -0.212158203125, 0.0, -0.63671875,     0.0,  0.63671875,
      0.0,  0.212158203125, 0.0,  0.12744140625,  0.0,  0.091064453125, 0.0,  0.07080078125,
      0.0,  0.057861328125, 0.0,  0.049072265625, 0.0,  0.0,            0.0,  0.0,
    )
  )

  val RX_Hilbert_Q = FIRConfig(
    FIRCodes.RX_HILBERT_Q,
    FixedPoint(16.W, 12.BP),
    Seq[Double](
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
      0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
    )
  )

  /*  Generated by software/models/notebooks/ble.ipynb

      Note only BLE or LRPWAN coefficients will be loaded by default
      For other mode, program new coefficients
   */
  val BLE = FIRMode(
    RX_match_sin_f0 = FIRConfig( // 1.75MHz
      FIRCodes.RX_MATCH_SIN_F0,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0,             0.02099609375,   0.03955078125,   0.0537109375,
         0.061279296875,  0.061767578125,  0.05517578125,   0.0419921875,
         0.02392578125,   0.003173828125, -0.01806640625,  -0.037109375,
        -0.052001953125, -0.060546875,    -0.062255859375, -0.056396484375,
        -0.044189453125, -0.026611328125, -0.006103515625,  0.01513671875,
         0.03466796875,   0.05029296875,   0.059814453125,  0.0625,
         0.057861328125,  0.04638671875,   0.029541015625,  0.00927734375,
         -0.01220703125, -0.0322265625,   -0.04833984375,  -0.058837890625,
      )
    ),

    RX_match_cos_f0 = FIRConfig( // 1.75MHz
      FIRCodes.RX_MATCH_COS_F0,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0625,          0.058837890625, 0.04833984375,   0.0322265625,
         0.01220703125,  -0.00927734375, -0.029541015625, -0.04638671875,
        -0.057861328125, -0.0625,        -0.059814453125, -0.05029296875,
        -0.03466796875,  -0.01513671875,  0.006103515625,  0.026611328125,
         0.044189453125,  0.056396484375, 0.062255859375,  0.060546875,
         0.052001953125,  0.037109375,    0.01806640625,  -0.003173828125,
        -0.02392578125,  -0.0419921875,  -0.05517578125,  -0.061767578125,
        -0.061279296875, -0.0537109375,  -0.03955078125,  -0.02099609375,
      )
    ),

    RX_match_sin_f1 = FIRConfig( // 2.25MHz
      FIRCodes.RX_MATCH_SIN_F1,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0,             0.026611328125,  0.04833984375,   0.060546875,
         0.061279296875,  0.05029296875,   0.029541015625,  0.003173828125,
        -0.02392578125,  -0.04638671875,  -0.059814453125, -0.061767578125,
        -0.052001953125, -0.0322265625,   -0.006103515625,  0.02099609375,
         0.044189453125,  0.058837890625,  0.062255859375,  0.0537109375,
         0.03466796875,   0.00927734375,  -0.01806640625,  -0.0419921875,
        -0.057861328125, -0.0625,         -0.05517578125,  -0.037109375,
        -0.01220703125,   0.01513671875,   0.03955078125,   0.056396484375,
      )
    ),

    RX_match_cos_f1 = FIRConfig( // 2.25MHz
      FIRCodes.RX_MATCH_COS_F1,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0625,          0.056396484375,  0.03955078125,   0.01513671875,
        -0.01220703125,  -0.037109375,    -0.05517578125,  -0.0625,
        -0.057861328125, -0.0419921875,   -0.01806640625,   0.00927734375,
         0.03466796875,   0.0537109375,    0.062255859375,  0.058837890625,
         0.044189453125,  0.02099609375,  -0.006103515625, -0.0322265625,
        -0.052001953125, -0.061767578125, -0.059814453125, -0.04638671875,
        -0.02392578125,   0.003173828125,  0.029541015625,  0.05029296875,
         0.061279296875,  0.060546875,     0.04833984375,   0.026611328125,
      )
    ),

    // Padded to length 32 for flexibility
    RX_lpf = FIRConfig( // 1MHz
      FIRCodes.RX_LPF,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
        0.00390625,     0.005859375,    0.010986328125, 0.01953125,
        0.03173828125,  0.046630859375, 0.062744140625, 0.077880859375,
        0.090576171875, 0.09912109375,  0.10205078125,  0.09912109375,
        0.090576171875, 0.077880859375, 0.062744140625, 0.046630859375,
        0.03173828125,  0.01953125,     0.010986328125, 0.005859375,
        0.00390625,     0.0,            0.0,            0.0,
        0.0,            0.0,            0.0,            0.0,
        0.0,            0.0,            0.0,            0.0,
      )
    ),
  )

  /* Generated by software/models/notebooks/lrwpan.ipynb

     Padded to length 32 since BLE needs it
   */
  val LRWPAN = FIRMode(
    RX_match_sin_f0 = FIRConfig( // 1.5MHz
      FIRCodes.RX_MATCH_SIN_F0,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0,             0.01806640625,   0.03466796875,   0.04833984375,
         0.057861328125,  0.062255859375,  0.061279296875,  0.05517578125,
         0.044189453125,  0.029541015625,  0.01220703125,  -0.006103515625,
        -0.02392578125,  -0.03955078125,  -0.052001953125, -0.059814453125,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
      )
    ),

    RX_match_cos_f0 = FIRConfig( // 1.5MHz
      FIRCodes.RX_MATCH_COS_F0,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0625,          0.059814453125,  0.052001953125,  0.03955078125,
         0.02392578125,   0.006103515625, -0.01220703125,  -0.029541015625,
        -0.044189453125, -0.05517578125,  -0.061279296875, -0.062255859375,
        -0.057861328125, -0.04833984375,  -0.03466796875,  -0.01806640625,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
      )
    ),

    RX_match_sin_f1 = FIRConfig( // 2.5MHz
      FIRCodes.RX_MATCH_SIN_F1,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0,             0.029541015625,  0.052001953125,  0.062255859375,
         0.057861328125,  0.03955078125,   0.01220703125,  -0.01806640625,
        -0.044189453125, -0.059814453125, -0.061279296875, -0.04833984375,
        -0.02392578125,   0.006103515625,  0.03466796875,   0.05517578125,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
         0.0,             0.0,             0.0,             0.0,
      )
    ),

    RX_match_cos_f1 = FIRConfig( // 2.5MHz
      FIRCodes.RX_MATCH_COS_F1,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
         0.0625,          0.05517578125,  0.03466796875,   0.006103515625,
        -0.02392578125,  -0.04833984375, -0.061279296875, -0.059814453125,
        -0.044189453125, -0.01806640625,  0.01220703125,   0.03955078125,
         0.057861328125,  0.062255859375, 0.052001953125,  0.029541015625,
         0.0,             0.0,            0.0,             0.0,
         0.0,             0.0,            0.0,             0.0,
         0.0,             0.0,            0.0,             0.0,
         0.0,             0.0,            0.0,             0.0,
      )
    ),

    RX_lpf = FIRConfig( // 2MHz
      FIRCodes.RX_LPF,
      FixedPoint(16.W, 12.BP),
      Seq[Double](
        -0.001953125,    -0.00146484375,  0.0,             0.005126953125,
         0.01611328125,   0.0341796875,   0.05810546875,   0.085205078125,
         0.110107421875,  0.127685546875, 0.134033203125,  0.127685546875,
         0.110107421875,  0.085205078125, 0.05810546875,   0.0341796875,
         0.01611328125,   0.005126953125, 0.0,            -0.00146484375,
        -0.001953125,     0.0,            0.0,             0.0,
         0.0,             0.0,            0.0,             0.0,
         0.0,             0.0,            0.0,             0.0,
      )
    ),
  )
}
